
<%- include ('_header') %> 
<div style="width: 25px">
  <table
    class="ui very basic collapsing celled table small"
    style="width: 25px"
    id="table"
  >
    <thead>
      <tr>
        <th>Products</th>
        <th>Jumlah</th>
        <th>Harga/kg</th>
        <th>Harga</th>
        <th>action</th>
      </tr>
    </thead>
    <tbody>
      <% for (let fruit of fruitsData){%>
      <tr id="<%=fruit.product%>">
        <td><%=fruit.product%></td>
        <td>
          <input
            type="number"
            style="width: 50px; height: 30px; border: none"
            name="sum<%=fruit.product%>"
            value="1"
            id="inputjumlah<%=fruit.product%>"
          />
        </td>
        <td id="harga<%=fruit.product%>"><%=fruit.harga%></td>
        <td id="total<%=fruit.product%>"><%=fruit.harga%></td>
        <td>
          <button class="small ui button" id="delete">
            <a href="/items/delete/<%=fruit.id%>">delete</a>
          </button>
        </td>
      </tr>
      <%}%>
    </tbody>
    <tfoot>
      <tr>
        <td colspan="4" id="totalBelanja">
          total Belanja: <span id="totalBelanjaText" onclick="lihatTotal()"> Click Untuk Lihat</span>
       
        </td>
      </tr>
      <tr>
        <td colspan="5">
          <button
            class="fluid ui button"
            onclick="checkOut()"
            disabled="true"
            id="buttonBuy"
          >
            Check Out
          </button>
        </td>
      </tr>
    </tfoot>
  </table>
</div>
</div>
<script>
//mendapatkan table dan elemen input saat elemen di load
document.addEventListener("DOMContentLoaded", function () {
  const table = document.querySelector("table");
  const inputElements = table.querySelectorAll('input[type="number"]');

  //melaukan looping inputElement dan menambahkan event input kedalamnya
  inputElements.forEach(function (inputElement) {
    inputElement.addEventListener("input", function () {
      // mendapatkan elemen tr dengan mencari elemen terdekat menggunakan closest
      const row = inputElement.closest("tr");
      const hargaElement = row.querySelector("td:nth-child(3)");
      const tdtotal = row.querySelector("td:nth-child(4)");

      //melakukan operasi harga total
      if (hargaElement && tdtotal) {
        const hargaValue = parseFloat(hargaElement.textContent);
        const inputValue = parseFloat(inputElement.value);
        const totalValue = hargaValue * inputValue;
        // Update totalvalue kedalam html
        tdtotal.textContent = totalValue;
        // lihatTotal()
      }
    });
  });
});
function lihatTotal() {
  const totalBelanja = document.getElementById("totalBelanja");
  const totalBelanjatext = document.getElementById("totalBelanjaText");
  const button = document.getElementById("buttonBuy");
  let totalArray = [];

  const rowTotal = document.querySelectorAll("#table td:nth-child(4)");
  for (x = 0; x < rowTotal.length; x++) {
    totalArray.push(parseInt(rowTotal[x].textContent));
  }
  const reducer = (a, b) => a + b;
  const arrayreduce = totalArray.reduce(reducer);
  totalArray = arrayreduce;
  totalBelanjatext.textContent = totalArray;
  if (totalArray) {
    button.disabled = false;
  }
}

function checkOut() {
  const checkOut = window.confirm("apakah anda sudah yakin?");
  if (checkOut) {
  saveItems()
  }
}

function saveItems() {
  let productArray = [];
  let sumArray = [];
  let totalArray = [];
  let hargaArray = [];
  let totbelanjaArray = [];
  const rowProduct = document.querySelectorAll("#table td:nth-child(1)");
  for (x = 0; x < rowProduct.length - 2; x++) {
    productArray.push(rowProduct[x].textContent);
  }
  productArray = productArray
    .map((item) => item.trim())
    .filter((item) => item !== "");
  console.log(productArray);

  const rowSum = document.querySelectorAll("#table td:nth-child(2) input");
  for (x = 0; x < rowSum.length; x++) {
    sumArray.push(parseInt(rowSum[x].value));
  }
  console.log(sumArray);

  const rowHarga = document.querySelectorAll("#table td:nth-child(3)");
  for (x = 0; x < rowHarga.length; x++) {
    hargaArray.push(parseInt(rowHarga[x].textContent));
  }
  console.log(hargaArray);

  const rowTotal = document.querySelectorAll("#table td:nth-child(4)");
  for (x = 0; x < rowTotal.length; x++) {
    totalArray.push(parseInt(rowTotal[x].textContent));
  }
  console.log(totalArray);
  const totalBelanja = document.getElementById("totalBelanjaText");
  totbelanjaArray.push(parseInt(totalBelanja.textContent));
  console.log(totbelanjaArray);

  //fetch here
  const dataSAVE = {
    product: productArray,
    sum: sumArray,
    harga: hargaArray,
    total: totalArray,
    totalBelanja: totbelanjaArray,
  };
  console.log(dataSAVE);
//menyimpan data dalam localstorage
// localStorage.setItem('CheckOutData', JSON.stringify(dataPOST))

  fetch("/items/CheckOut", {
    method: "POST",
    headers: { "Content-type": "application/json" },
    body: JSON.stringify(dataSAVE),
  })
  .then((response) => {
  if (!response.ok) {
    throw new Error(`HTTP error! Status: ${response.status}`);
  }
  return response.text();
})
    .then((data) => console.log( "respons server : ",data))
    .catch((err) => {
      console.error(err);
    });
    window.location.href=`/items/CheckOut?data=${encodeURIComponent(JSON.stringify(dataSAVE))}`
 }

// function reloadPage() {
//   setTimeout(function () {
//     location.reload();
//   }, 800);
// }
</script>
